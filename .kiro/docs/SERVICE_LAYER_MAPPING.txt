KAYTOP SERVICE LAYER MAPPING
=============================

=== API CLIENT CONFIGURATION ===

File: lib/api/config.ts
- API_CONFIG: Central configuration object
  - BASE_URL: https://kaytop-production.up.railway.app
  - TIMEOUT: 30000ms (configurable)
  - RETRY_ATTEMPTS: 3 (configurable)
  - RETRY_DELAY: 1000ms (configurable)
  - DEBUG: true in development
  - LOG_API_CALLS: true in development
  - CACHE_ENABLED: true
  - CACHE_TTL: 300000ms (5 minutes)

- API_ENDPOINTS: Centralized endpoint definitions
  - AUTH: Login, signup, password reset, profile
  - USERS: User management endpoints
  - ADMIN: Admin-specific endpoints
  - LOANS: Loan management endpoints
  - CUSTOMER_LOANS: Customer-specific loan endpoints
  - SAVINGS: Savings management endpoints
  - CUSTOMER_SAVINGS: Customer-specific savings endpoints
  - OTP: OTP endpoints
  - DASHBOARD: Dashboard KPI endpoint
  - REPORTS: Reports management endpoints
  - ACTIVITY_LOGS: Activity logging endpoints
  - SYSTEM_SETTINGS: System configuration endpoints
  - BULK: Bulk operations endpoints

=== UNIFIED API CLIENT ===

File: lib/api/client.ts
Class: UnifiedHttpClient
Methods:
  - get<T>(url, config?): Promise<ApiResponse<T>>
  - post<T>(url, data?, config?): Promise<ApiResponse<T>>
  - put<T>(url, data?, config?): Promise<ApiResponse<T>>
  - patch<T>(url, data?, config?): Promise<ApiResponse<T>>
  - delete<T>(url, config?): Promise<ApiResponse<T>>

Features:
  - Automatic retry with exponential backoff
  - Request/response interceptors
  - Automatic data transformation based on endpoint
  - Comprehensive error handling
  - Request logging
  - Timeout handling
  - FormData support for file uploads

Export: apiClient (singleton instance)

=== DATA TRANSFORMERS ===

File: lib/api/transformers.ts
Class: DataTransformers
Methods:
  - transformUser(backendUser): User
  - transformLoan(backendLoan): Loan
  - transformSavingsAccount(backendSavings): SavingsAccount
  - transformTransaction(backendTransaction): Transaction
  - transformDashboardKPIs(backendData): DashboardKPIs
  - transformPaginatedResponse(response, transformFn): PaginatedResponse<T>
  - normalizeLoanStatus(status): string
  - normalizeSavingsStatus(status): string
  - normalizeTransactionStatus(isApproved): string

Purpose: Normalize backend response formats to frontend types

=== ERROR HANDLING ===

File: lib/api/errorHandler.ts
Class: UnifiedAPIErrorHandler
Methods:
  - handleError(error): void
  - logErrorWithContext(error, context): void
  - createErrorResponse(error): ApiError

Features:
  - Centralized error logging
  - Error context tracking
  - Error classification (auth, network, server)
  - Error recovery suggestions

=== AUTHENTICATION MANAGER ===

File: lib/api/authManager.ts
Class: AuthenticationManager
Methods:
  - getAuthHeaders(): Promise<Record<string, string>>
  - handleAuthenticationFailure(): void
  - refreshToken(): Promise<string>
  - logout(): void

Features:
  - Token management
  - Automatic token refresh
  - Auth failure handling
  - Session management

=== INTERCEPTORS ===

File: lib/api/interceptors.ts
Class: InterceptorManager
Methods:
  - executeRequestInterceptors(url, config): void
  - executeResponseInterceptors(response): void
  - executeResponseErrorInterceptors(error): void

Features:
  - Request preprocessing
  - Response postprocessing
  - Error interception

=== SERVICE LAYER ===

=== Dashboard Service ===
File: lib/services/dashboard.ts
Class: DashboardAPIService
Methods:
  - getKPIs(params?: DashboardParams): Promise<DashboardKPIs>
  - getLoanStatistics(params?: DashboardParams): Promise<LoanStatistics>
Endpoints Used:
  - GET /dashboard/kpi

=== User Service ===
File: lib/services/users.ts
Class: UserAPIService
Methods:
  - getAllUsers(params?: UserFilterParams): Promise<PaginatedResponse<User>>
  - getUserById(id: string): Promise<User>
  - getUserByEmail(email: string): Promise<User>
  - createStaffUser(data: CreateStaffData): Promise<User>
  - updateUser(id: string, data: UpdateUserData): Promise<User>
  - deleteUser(id: string): Promise<void>
  - updateUserRole(id: string, role: string): Promise<User>
  - getUsersByBranch(branch: string, params?: PaginationParams): Promise<PaginatedResponse<User>>
  - getUsersByState(state: string, params?: PaginationParams): Promise<PaginatedResponse<User>>
  - getMyStaff(): Promise<User[]>
Endpoints Used:
  - GET /admin/users
  - GET /admin/users/{id}
  - GET /admin/user/{email}
  - PATCH /admin/users/{id}
  - DELETE /admin/users/{id}
  - PATCH /admin/users/{id}/update-role
  - GET /admin/users/branch/{branch}
  - GET /admin/users/state/{state}
  - POST /admin/staff/create
  - GET /admin/staff/my-staff

=== Loan Service ===
File: lib/services/loans.ts
Class: LoanAPIService
Methods:
  - createLoan(customerId: string, data: CreateLoanData): Promise<Loan>
  - disburseLoan(loanId: string, proof: File): Promise<Loan>
  - recordRepayment(loanId: string, data: RepaymentData): Promise<any>
  - getLoanSummary(customerId: string): Promise<LoanSummary>
  - getDisbursementSummary(customerId: string): Promise<DisbursementSummary>
  - getCustomerLoans(customerId: string): Promise<Loan[]>
  - getLoanRepayments(loanId: string): Promise<RepaymentData[]>
Endpoints Used:
  - POST /loans/customer/{customerId}
  - PUT /loans/{loanId}/disburse
  - POST /loans/{loanId}/repayments
  - GET /loans/customer/{customerId}/loan-summary
  - GET /loans/customer/{customerId}/disbursement-summary
  - GET /loans/customer/{customerId}
  - GET /loans/{loanId}/repayments

=== Savings Service ===
File: lib/services/savings.ts
Class: SavingsAPIService
Methods:
  - recordDeposit(customerId: string, data: DepositData): Promise<Transaction>
  - recordWithdrawal(customerId: string, data: WithdrawalData): Promise<Transaction>
  - useSavingsForLoanCoverage(customerId: string, data: LoanCoverageData): Promise<Transaction>
  - approveTransaction(transactionId: string, type: 'withdrawal' | 'loan-coverage'): Promise<Transaction>
  - getCustomerSavings(customerId: string): Promise<SavingsAccount>
  - getCustomerTransactions(customerId: string, filters?): Promise<{ transactions, pagination }>
Endpoints Used:
  - POST /savings/customer/{customerId}/deposit
  - POST /savings/customer/{customerId}/withdraw
  - POST /savings/customer/{customerId}/loan-coverage
  - PUT /savings/transactions/{transactionId}/approve-withdraw
  - PUT /savings/transactions/{transactionId}/approve-loan-coverage
  - GET /savings/customer/{customerId}

=== Profile Service ===
File: lib/services/profile.ts
Class: ProfileManagementService
Methods:
  - getProfile(): Promise<AdminProfile>
  - updateProfile(data: UpdateUserData): Promise<AdminProfile>
  - uploadProfilePicture(file: File): Promise<AdminProfile>
  - changePassword(data: ChangePasswordData): Promise<void>
Endpoints Used:
  - GET /admin/profile
  - PATCH /users/me
  - PATCH /users/me/profile-picture
  - POST /auth/change-password

=== System Settings Service ===
File: lib/services/systemSettings.ts
Class: SystemSettingsAPIService
Methods:
  - getSystemSettings(): Promise<SystemSettings>
  - updateSystemSettings(settings: Partial<SystemSettings>): Promise<SystemSettings>
Endpoints Used:
  - GET /admin/system-settings
  - PUT /admin/system-settings

=== Activity Logs Service ===
File: lib/services/activityLogs.ts
Class: ActivityLogsAPIService
Methods:
  - getActivityLogs(filters?: ActivityLogFilters): Promise<PaginatedResponse<ActivityLog>>
  - getUserActivityLogs(userId: string, filters?): Promise<PaginatedResponse<ActivityLog>>
Endpoints Used:
  - GET /admin/activity-logs
  - GET /admin/activity-logs/user/{userId}

=== Reports Service ===
File: lib/services/reports.ts
Class: ReportsAPIService
Methods:
  - getAllReports(filters?: ReportFilters): Promise<PaginatedResponse<Report>>
  - getReportById(id: string): Promise<Report>
  - approveReport(id: string, data: ReportApprovalData): Promise<Report>
  - declineReport(id: string, data: ReportApprovalData): Promise<Report>
  - getReportStatistics(filters?): Promise<ReportStatistics>
Endpoints Used:
  - GET /reports
  - GET /reports/{id}
  - POST /reports/{id}/approve
  - POST /reports/{id}/decline
  - GET /reports/statistics

=== Export Service ===
File: lib/services/export.ts
Class: ExportAPIService
Methods:
  - exportUsers(filters?, format?): Promise<Blob>
  - exportLoans(filters?, format?): Promise<Blob>
  - exportReports(filters?, format?): Promise<Blob>
  - exportActivityLogs(filters?, format?): Promise<Blob>
  - getExportHistory(): Promise<ExportHistoryItem[]>
Endpoints Used:
  - GET /admin/users/export
  - GET /admin/exports/history

=== Branch Service ===
File: lib/services/branches.ts
Class: BranchAPIService
Methods:
  - getAllBranches(params?: PaginationParams): Promise<PaginatedResponse<Branch>>
  - getBranchById(id: string): Promise<BranchDetails>
  - createBranch(data: CreateBranchData): Promise<Branch>
  - updateBranch(id: string, data: UpdateBranchData): Promise<Branch>
  - deleteBranch(id: string): Promise<void>
  - getBranchStatistics(id: string): Promise<BranchStatistics>
  - getBranchesByState(state: string, params?): Promise<PaginatedResponse<Branch>>
  - getBranchesByRegion(region: string, params?): Promise<PaginatedResponse<Branch>>
Endpoints Used:
  - GET /admin/branches
  - GET /admin/branches/{id}
  - POST /admin/branches
  - PATCH /admin/branches/{id}
  - DELETE /admin/branches/{id}
  - GET /admin/branches/{id}/statistics
  - GET /admin/branches/state/{state}
  - GET /admin/branches/region/{region}

=== Unified Services (Simplified API) ===

=== Unified User Service ===
File: lib/services/unifiedUser.ts
Class: UnifiedUserAPIService
Methods:
  - getUsers(params?: UserFilterParams): Promise<PaginatedResponse<User>>
  - getUserById(id: string): Promise<User>
  - updateUser(id: string, data: Partial<User>): Promise<User>
  - createUser(userData: CreateUserRequest): Promise<User>
  - deleteUser(id: string): Promise<void>
  - searchUsers(params: UserFilterParams): Promise<PaginatedResponse<User>>
Purpose: Simplified unified interface for user operations

=== Unified Loan Service ===
File: lib/services/unifiedLoan.ts
Class: UnifiedLoanAPIService
Methods:
  - getLoans(params?: LoanFilterParams): Promise<PaginatedResponse<Loan>>
  - getLoanById(id: string): Promise<Loan>
  - getCustomerLoans(customerId: string): Promise<PaginatedResponse<Loan>>
  - getDisbursedLoans(params?): Promise<PaginatedResponse<Loan>>
  - getRecollections(params?): Promise<PaginatedResponse<Loan>>
  - getMissedPayments(params?): Promise<PaginatedResponse<Loan>>
  - createLoan(customerId: string, loanData: CreateLoanData): Promise<Loan>
  - disburseLoan(loanId: string): Promise<Loan>
  - getLoanRepayments(loanId: string): Promise<any[]>
  - getLoanSummary(customerId: string): Promise<any>
  - getDisbursementSummary(customerId: string): Promise<any>
  - approveLoan(id: string, notes?, conditions?): Promise<any>
  - declineLoan(id: string, reason: string, notes?): Promise<any>
  - updateLoanStage(id: string, stage: string, notes?): Promise<Loan>
Purpose: Unified interface for loan operations

=== Unified Savings Service ===
File: lib/services/unifiedSavings.ts
Class: UnifiedSavingsAPIService
Methods:
  - getSavingsAccounts(params?: SavingsFilterParams): Promise<PaginatedResponse<SavingsAccount>>
  - getCustomerSavings(customerId: string): Promise<SavingsAccount>
  - getSavingsTransactions(params?: TransactionFilterParams): Promise<PaginatedResponse<SavingsTransaction>>
  - approveWithdrawal(transactionId: string): Promise<Transaction>
  - approveLoanCoverage(transactionId: string): Promise<Transaction>
  - depositToCustomer(customerId: string, amount: number, description: string): Promise<Transaction>
  - withdrawFromCustomer(customerId: string, amount: number, description: string): Promise<Transaction>
Purpose: Unified interface for savings operations

=== Unified Dashboard Service ===
File: lib/services/unifiedDashboard.ts
Class: UnifiedDashboardAPIService
Methods:
  - getKPIs(params?: DashboardParams): Promise<DashboardKPIs>
Purpose: Unified interface for dashboard operations

=== Bulk Loans Service ===
File: lib/services/bulkLoans.ts
Class: BulkLoansAPIService
Methods:
  - getBulkLoans(filters?: BulkLoansFilters): Promise<BulkLoansResponse>
  - getLoanStatistics(filters?): Promise<LoanStatistics>
Purpose: Aggregate loan data from multiple customer endpoints

=== APP SERVICES (Legacy) ===

File: app/services/authService.ts
Class: AuthService
Methods:
  - login(data: LoginData): Promise<LoginResponse>
  - forgotPassword(data: ForgotPasswordData): Promise<ForgotPasswordResponse>
  - verifyOtp(data: OtpData): Promise<VerifyOtpResponse>
  - sendOtp(data: OtpData): Promise<VerifyOtpResponse>
  - resetPassword(data: ResetPasswordData): Promise<ResetPasswordResponse>
  - changePassword(data: ChangePasswordData): Promise<any>
Endpoints Used:
  - POST /auth/login
  - POST /auth/forgot-password
  - POST /otp/verify
  - POST /otp/send
  - POST /auth/reset-password
  - POST /auth/change-password

File: app/services/dashboardService.ts
Class: DashboardService
Methods:
  - getDashboardKpi(params: DashboardProps): Promise<DashboardKpi>
  - getLoanDisbursed(params: LoanDisbursedProps): Promise<LoanDisbursedResponse>
  - getLoanRecollection(params: LoanDisbursedProps): Promise<LoanRecollectionResponse>
  - getSavings(params: LoanDisbursedProps): Promise<SavingsApiResponse>
  - getMissedPayment(params: MissedPaymentProps): Promise<MissedPaymentResponse>
  - getDisbursedVolume(): Promise<LoanDisbursedVolumeResponse[]>
Endpoints Used:
  - GET /dashboard/kpi
  - GET /loans/disbursed
  - GET /loans/recollections
  - GET /savings/all
  - GET /loans/missed
  - GET /loans/disbursed/volume

File: app/services/customerService.ts
Class: CustomerService
Methods:
  - getCustomersByBranch(params: QueryParamsProps): Promise<CustomerListResponse>
  - getBranchCustomerById(customerId: number): Promise<CustomerDataResponse>
  - getBranchCustomerLoan(customerId: number): Promise<ActiveLoanData[]>
  - getBranchCustomerSavings(params: QueryParamsProps): Promise<CustomerSavingsResponse>
  - getLoanPaymentsSchedule(params: QueryParamsProps): Promise<PaymentSchedule>
  - getCustomerSavingsProgress(customerId: number): Promise<SavingsProgressResponse>
Endpoints Used:
  - GET /users/my-branch
  - GET /admin/users/{customerId}
  - GET /loans/customer/{customerId}
  - GET /savings/customer/{customerId}
  - GET /loans/{loanId}/payment-schedule
  - GET /savings/customer/{customerId}/progress

File: app/services/loanService.ts
Class: LoanService
Methods:
  - getBranchLoans(params: QueryParamsProps): Promise<BranchLoanResponse>
  - getLoanDetails(params: QueryParamsProps): Promise<LoanDetailsResponse>
Endpoints Used:
  - GET /loans
  - GET /loans/{loanId}/details

=== RESPONSE TRANSFORMATION FLOW ===

1. API Request
   ↓
2. UnifiedHttpClient.makeRequest()
   ↓
3. Execute Request Interceptors
   ↓
4. Fetch API
   ↓
5. Check Response Status
   ↓
6. Parse Response (JSON or text)
   ↓
7. transformResponse() - Endpoint-specific transformation
   ↓
8. DataTransformers.transform*() - Normalize data structure
   ↓
9. Execute Response Interceptors
   ↓
10. Return ApiResponse<T>
    ↓
11. Service Layer processes response
    ↓
12. Component receives typed data

=== ERROR HANDLING FLOW ===

1. API Error Occurs
   ↓
2. UnifiedHttpClient catches error
   ↓
3. Classify error type (auth, network, server)
   ↓
4. UnifiedAPIErrorHandler.logErrorWithContext()
   ↓
5. Execute Error Interceptors
   ↓
6. Handle auth errors (logout if 401/403)
   ↓
7. Retry if retryable (408, 429, 500-504)
   ↓
8. Throw error to caller
   ↓
9. Service layer catches and re-throws
   ↓
10. Component catches and displays error

=== RETRY LOGIC ===

Retryable Status Codes: 408, 429, 500, 502, 503, 504
Max Retries: 3 (configurable)
Backoff Strategy: Exponential (2^attempt * delay)
Initial Delay: 1000ms (configurable)
Max Delay: 10000ms (configurable)

=== CACHING STRATEGY ===

Cache Enabled: true (configurable)
Cache TTL: 300000ms (5 minutes, configurable)
Cached Endpoints: All GET requests
Cache Key: URL + query parameters
Cache Invalidation: Manual or TTL expiry

=== AUTHENTICATION FLOW ===

1. User logs in via /auth/login
   ↓
2. Backend returns token
   ↓
3. Token stored in localStorage as auth_session
   ↓
4. AuthenticationManager.getAuthHeaders() adds token to requests
   ↓
5. Token automatically included in Authorization header
   ↓
6. If 401/403 received, AuthenticationManager.handleAuthenticationFailure()
   ↓
7. User logged out and redirected to login page
